{% extends "layout.html" %}

{% block title %}My Diary - LifeLog{% endblock %}

{% block content %}
<div class="diary-page">
    <div class="diary-header">
        <div class="header-content">
            <h1><i class="fas fa-feather-alt"></i> New Diary Entry</h1>
            <div class="date-display">
                <i class="far fa-calendar-alt"></i> {{ today_date|datetime('%A, %B %d, %Y') }}
            </div>
        </div>
        <div class="header-decoration">
            <div class="floating-icon icon-1"><i class="fas fa-pen-fancy"></i></div>
            <div class="floating-icon icon-2"><i class="fas fa-book-open"></i></div>
            <div class="floating-icon icon-3"><i class="fas fa-heart"></i></div>
        </div>
    </div>
    
    <div class="diary-container">
        <form action="{{ url_for('diary') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="diary-tools">
                <div class="tool-section">
                    <div class="language-selector">
                        <label for="language"><i class="fas fa-language"></i> Language:</label>
                        <select id="language" name="language" class="form-control">
                            <option value="auto">Auto Detect</option>
                            <option value="en">English</option>
                            <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                            <option value="hi">Hindi</option>
                            <option value="ja">Japanese</option>
                            <option value="zh-CN">Chinese</option>
                            <option value="ru">Russian</option>
                            <option value="ar">Arabic</option>
                        </select>
                    </div>
                    
                    <div class="voice-record">
                        <button type="button" id="record-button" class="btn btn-outline">
                            <i class="fas fa-microphone"></i> <span id="record-text">Start Recording</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mood-selector">
                <div class="mood-label">How are you feeling today?</div>
                <div class="mood-options">
                    <label class="mood-option">
                        <input type="radio" name="mood" value="Positive" checked>
                        <span class="mood-icon positive">üòä</span>
                        <span class="mood-text">Positive</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="Neutral">
                        <span class="mood-icon neutral">üòê</span>
                        <span class="mood-text">Neutral</span>
                    </label>
                    <label class="mood-option">
                        <input type="radio" name="mood" value="Negative">
                        <span class="mood-icon negative">üòî</span>
                        <span class="mood-text">Negative</span>
                    </label>
                </div>
            </div>
            
            <div class="diary-content-area">
                <div class="form-group date-input">
                    <label for="entry_date"><i class="far fa-calendar"></i> Entry Date:</label>
                    <input type="date" id="entry_date" name="entry_date" value="{{ today_date }}" required>
                </div>
                
                <div class="form-group diary-text-container">
                    <div class="text-area-wrapper">
                        <textarea id="diary-text" name="diary_text" placeholder="Write your thoughts here..." required></textarea>
                        <div class="word-count">
                            <i class="fas fa-pencil-alt"></i> Words: <span id="word-count">0</span>
                        </div>
                    </div>
                    <div class="translation-preview">
                        <div class="preview-header">
                            <i class="fas fa-language"></i> Translation Preview
                        </div>
                        <div id="translation-text" class="preview-content"></div>
                    </div>
                </div>
            </div>
            
            <div class="diary-controls">
                <button type="button" id="clear-entry" class="control-btn secondary">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button type="button" id="save-draft" class="control-btn secondary">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button type="button" id="analyze-mood" class="control-btn secondary">
                    <i class="fas fa-smile"></i> Analyze Mood
                </button>
                <button type="button" id="add-template" class="control-btn secondary">
                    <i class="fas fa-file-alt"></i> Use Template
                </button>
            </div>
            
            <div class="diary-actions">
                <button type="submit" class="btn btn-primary btn-full">
                    <i class="fas fa-check-circle"></i> Save Entry
                </button>
                <a href="{{ url_for('entries') }}" class="btn btn-secondary btn-full">
                    <i class="fas fa-times-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update word count on input
    const diaryText = document.getElementById('diary-text');
    const wordCount = document.getElementById('word-count');
    const languageSelector = document.getElementById('language');
    const translationText = document.getElementById('translation-text');
    let translationTimeout = null;
    
    // Function to translate text
    async function translateText(text, sourceLang) {
        if (!text.trim()) {
            translationText.textContent = '';
            return;
        }
        
        try {
            console.log(`Translating text: "${text.substring(0, 50)}..." with source language: ${sourceLang}`);
            
            const response = await fetch('/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({
                    text: text,
                    source_lang: sourceLang
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Translation response:', data);
                
                if (data.error) {
                    console.error('Translation error:', data.error);
                    translationText.textContent = 'Translation failed. Please try again.';
                } else {
                    translationText.textContent = data.translation;
                    
                    // If auto-detection was used, update the language selector
                    if (sourceLang === 'auto' && data.source_lang) {
                        const option = languageSelector.querySelector(`option[value="${data.source_lang}"]`);
                        if (option) {
                            languageSelector.value = data.source_lang;
                        }
                    }
                }
            } else {
                console.error('Translation failed:', response.statusText);
                translationText.textContent = 'Translation failed. Please try again.';
            }
        } catch (error) {
            console.error('Translation error:', error);
            translationText.textContent = 'Translation failed. Please try again.';
        }
    }
    
    // Update translation on input with debounce
    diaryText.addEventListener('input', function() {
        const text = this.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        wordCount.textContent = words;
        
        // Clear previous timeout
        if (translationTimeout) {
            clearTimeout(translationTimeout);
        }
        
        // Set new timeout for translation
        translationTimeout = setTimeout(() => {
            if (text) {
                const selectedLang = languageSelector.value;
                console.log(`Selected language: ${selectedLang}`);
                translateText(text, selectedLang);
            } else {
                translationText.textContent = '';
            }
        }, 500); // Wait 500ms after user stops typing
    });
    
    // Update translation when language changes
    languageSelector.addEventListener('change', function() {
        const text = diaryText.value.trim();
        if (text) {
            translateText(text, this.value);
        }
    });
    
    // Clear entry
    const clearEntryBtn = document.getElementById('clear-entry');
    clearEntryBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the current entry?')) {
            diaryText.value = '';
            wordCount.textContent = '0';
            translationText.textContent = '';
        }
    });
    
    // Voice recording functionality
    const recordButton = document.getElementById('record-button');
    const recordText = document.getElementById('record-text');
    let isRecording = false;
    let recognition = null;

    // Check if browser supports speech recognition
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = languageSelector.value; // Use selected language

        recognition.onstart = function() {
            isRecording = true;
            recordText.textContent = 'Stop Recording';
            recordButton.classList.add('recording');
        };

        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }

            // Update the textarea with the transcribed text
            if (finalTranscript) {
                diaryText.value += ' ' + finalTranscript;
                const text = diaryText.value.trim();
                const words = text ? text.split(/\s+/).length : 0;
                wordCount.textContent = words;
                
                // Trigger translation
                if (translationTimeout) {
                    clearTimeout(translationTimeout);
                }
                translationTimeout = setTimeout(() => {
                    translateText(text, languageSelector.value);
                }, 500);
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isRecording = false;
            recordText.textContent = 'Start Recording';
            recordButton.classList.remove('recording');
        };

        recognition.onend = function() {
            isRecording = false;
            recordText.textContent = 'Start Recording';
            recordButton.classList.remove('recording');
        };
    } else {
        recordButton.disabled = true;
        recordText.textContent = 'Speech Recognition Not Supported';
        console.error('Speech recognition not supported in this browser');
    }

    recordButton.addEventListener('click', function() {
        if (!recognition) return;
        
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.lang = languageSelector.value;
            recognition.start();
        }
    });

    // Template functionality
    const addTemplateBtn = document.getElementById('add-template');
    addTemplateBtn.addEventListener('click', function() {
        const templates = [
            "Today I felt...\n\nThe best part of my day was...\n\nI'm grateful for...\n\nTomorrow I plan to...",
            "Morning reflection:\n\nAfternoon activities:\n\nEvening thoughts:\n\nLessons learned today:",
            "Achievements today:\n\nChallenges faced:\n\nThoughts and feelings:\n\nPlans for tomorrow:"
        ];
        
        const templateIndex = Math.floor(Math.random() * templates.length);
        diaryText.value = templates[templateIndex];
        const words = diaryText.value.trim().split(/\s+/).length;
        wordCount.textContent = words;
    });
    
    // Analyze mood functionality
    const analyzeMoodBtn = document.getElementById('analyze-mood');
    analyzeMoodBtn.addEventListener('click', function() {
        const text = diaryText.value.trim();
        if (!text) {
            alert('Please write something first to analyze mood.');
            return;
        }
        
        // This would normally connect to a sentiment analysis API
        // For now, we'll just use a simple algorithm
        const positiveWords = ['happy', 'joy', 'excited', 'love', 'great', 'wonderful', 'amazing', 'good'];
        const negativeWords = ['sad', 'angry', 'upset', 'hate', 'terrible', 'awful', 'bad', 'disappointed'];
        
        let positiveCount = 0;
        let negativeCount = 0;
        
        const words = text.toLowerCase().split(/\W+/);
        
        words.forEach(word => {
            if (positiveWords.includes(word)) positiveCount++;
            if (negativeWords.includes(word)) negativeCount++;
        });
        
        let mood;
        if (positiveCount > negativeCount) {
            mood = 'Positive';
        } else if (negativeCount > positiveCount) {
            mood = 'Negative';
        } else {
            mood = 'Neutral';
        }
        
        // Select the appropriate radio button
        document.querySelector(`input[name="mood"][value="${mood}"]`).checked = true;
        
        alert(`Based on your text, your mood seems to be: ${mood}`);
    });
    
    // Save draft functionality
    const saveDraftBtn = document.getElementById('save-draft');
    saveDraftBtn.addEventListener('click', function() {
        const text = diaryText.value.trim();
        if (!text) {
            alert('Please write something first to save as draft.');
            return;
        }
        
        localStorage.setItem('diary_draft', text);
        localStorage.setItem('diary_draft_date', document.getElementById('entry_date').value);
        localStorage.setItem('diary_draft_time', new Date().toISOString());
        
        alert('Draft saved successfully! You can continue later.');
    });
    
    // Load draft if exists
    window.addEventListener('load', function() {
        const savedDraft = localStorage.getItem('diary_draft');
        const savedDate = localStorage.getItem('diary_draft_date');
        const savedTime = localStorage.getItem('diary_draft_time');
        
        if (savedDraft && savedDate && savedTime) {
            const savedTimeObj = new Date(savedTime);
            const timeAgo = Math.round((new Date() - savedTimeObj) / (1000 * 60)); // minutes
            
            if (confirm(`You have a saved draft from ${timeAgo} minutes ago. Would you like to load it?`)) {
                diaryText.value = savedDraft;
                document.getElementById('entry_date').value = savedDate;
                const words = savedDraft.split(/\s+/).length;
                wordCount.textContent = words;
            } else {
                // Clear the draft if user doesn't want to load it
                localStorage.removeItem('diary_draft');
                localStorage.removeItem('diary_draft_date');
                localStorage.removeItem('diary_draft_time');
            }
        }
    });
</script>

<style>
    .translation-preview {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .preview-header {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .preview-content {
        color: #212529;
        line-height: 1.5;
        min-height: 2em;
    }
</style>
{% endblock %}

